SELECT
	s.*
FROM
(
select clients.name,
	(SELECT t.caller_id_num FROM ast_calls t WHERE t.client_id=clients.id AND t.call_type='in' order by start_time DESC limit 1) AS tel,
	clients.create_date
 from clients
where clients.create_date>='2019-04-01' AND substring(name,1,6)='Клиент'
ORDER BY clients.create_date
) As s
WHERE s.tel IS NOT NULL AND substring(s.tel,1,1)='9'





DELETE FROM vehicle_owner_clients;
INSERT INTO vehicle_owner_clients
(vehicle_owner_id,client_id)
(
SELECT
	t.id AS vehicle_owner_id,
	t.client_id
FROM vehicle_owners AS t
WHERE t.client_id IS NOT NULL
)


DELETE FROM vehicle_owner_concrete_prices;
INSERT INTO vehicle_owner_concrete_prices
(vehicle_owner_id,concrete_costs_for_owner_h_id,date)
(
SELECT
	t.id AS vehicle_owner_id,
	t.concrete_costs_for_owner_h_id,
	now()::date
FROM vehicle_owners AS t
WHERE t.concrete_costs_for_owner_h_id IS NOT NULL
)



/*
UPDATE vehicle_owner_concrete_prices
SET client_id=s.client_id
FROM(
SELECT v.client_id,v.id AS vehicle_owner_id
FROM vehicle_owner_concrete_prices AS p
LEFT JOIN vehicle_owners v ON v.id=p.vehicle_owner_id
) AS s
WHERE s.vehicle_owner_id=vehicle_owner_concrete_prices.vehicle_owner_id
*/
--SELECT * FROM vehicle_owner_concrete_prices
--ALTER TABLE vehicle_owner_concrete_prices DROP CONSTRAINT vehicle_owner_concrete_prices_pkey;
ALTER TABLE vehicle_owner_concrete_prices ADD PRIMARY KEY (vehicle_owner_id,client_id,date);
